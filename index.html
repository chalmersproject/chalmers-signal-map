<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin="" />
  <!-- Make sure you put this AFTER Leaflet's CSS -->
  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>
  <style media="screen">
    *
    {
      magin: 0;
      padding: 0;
    }
    body
    {
      background: black;
    }
    .leaflet-container
    {
      background: black;
    }
    .leaflet-popup-content-wrapper, .leaflet-popup-tip
    {
      background-color: black;
      color: white;
    }
    #mapid {
      height: 98vh;
    }
  </style>

  <title>chalmers map</title>
</head>

<body>
  <div id="mapid"></div>
</body>
<script type="text/javascript">
  var chalmers_map = L.map('mapid').setView([43.6492, -79.3995], 17);
  var shelter_circles = [];

  L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png', {
    maxZoom: 20,
    attribution: '<a href="https://chalmerscards.com">Chalmers Map</a> + &copy; <a href="https://stadiamaps.com/">Stadia  Maps</a>, &copy; <a href="https://openmaptiles.org/ ">OpenMapTiles</a> &copy; <a href="http://  openstreetmap.org">OpenStreetMap</a> contributors'
  }).addTo(chalmers_map);

  // sets default map view to above st felix augusta
  chalmers_map.setView([43.6492, -79.3995], 14);

  //* Utility Functions *//
  function GetData(url) {
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.open("GET", url, false);
    xmlhttp.send(null);
    return xmlhttp.responseText;
  }
  const scale = (num, in_min, in_max, out_min, out_max) => {
    return (num - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
  }
  function map_occupancy_to_color(occupacy, capacity) {
    var red = scale(occupacy, 0, capacity, 0, 255);
    var blue = scale(occupacy, 0, capacity, 255, 0);
    return "rgb(" + red + "," + 0  + "," + blue +  ")";
  }

  var radius_min, radius_max;
  function set_circle_radius(circle, map)
  {
    radius_min = 25;
    radius_max = 80;
    var radius_mult = 2;
    var myZoom = {
      start:  map.getZoom(),
      end: map.getZoom()
    };

    map.on('zoomstart', function(e) {
      myZoom.start = map.getZoom();
    });

    map.on('zoomend', function(e) {
      myZoom.end = map.getZoom();
      var diff = myZoom.start - myZoom.end;
      if (diff > 0) {
        circle.setRadius(circle.getRadius() * radius_mult);
      } else if (diff < 0) {
        circle.setRadius(circle.getRadius() / radius_mult);
      }
      if (radius_min >=  circle.getRadius())
      {
        circle.setRadius(radius_min);
      }else if (circle.getRadius() >= radius_max) {
        circle.setRadius(radius_max);
      }
    });
  }

  function display_populations_served(client_properties) {
    populations_served_string = "";
    for (var key of Object.keys(client_properties)){
      if (client_properties[key]) {
        populations_served_string = populations_served_string + key;
      }
      populations_served_string = populations_served_string +  " ";
    }
    return populations_served_string;
  }
  function bindPopup(current_shelter_circle){
    current_shelter_circle.bindPopup(
      "<h3>" +
        current_shelter_info.Shelter_Contact.friendly_name +
      "</h3>" +
      "<h4>Occupancy</h4>"
      + "<p>"+ current_shelter_occupancy + "    " + "/" + "    " + current_shelter_capacity + "</p>" +
      "<h4>Phone Number</h4>" +
        "<p>" + current_shelter_info.Shelter_Contact.phone_number + "</p>" +
      "<h4>Populations Served</h4>" +
        "<p>" + display_populations_served(current_shelter_info.Client_Properties) + "</p>"
    );
  }
  var shelters_json, shelter_names, current_shelter_info, current_shelter_name, current_shelter_occupancy, current_shelter_capacity, current_circle_color;
  function grab_data() {
    //Get Firebase Data
    shelters_json = JSON.parse(GetData("https://chalmers-signal.firebaseio.com/Shelters.json"));
    shelter_names = Object.keys(shelters_json);
    /*
    //On refresh remove existing shelter cirlces and redraw them
    if(shelter_circles.length > 0) {
      for (var i = 0; i < shelter_circles.length; i++) {
        shelter_circles[i].remove();
      }
    }*/
  }
  function render_shelters(create_shelters){
    //Get List of Shelters and Assign Shelter Details to it
    grab_data();
    for (var i = 0; i < shelter_names.length; i++) {
      current_shelter_name = shelter_names[i];

      //Parse Important Shelter Information
      current_shelter_info = shelters_json[current_shelter_name];

      //Parse information that determines cirlce colour
      current_shelter_occupancy = current_shelter_info.Service_Status.Firecode_Space.Firecode_Occupancy;
      current_shelter_capacity = current_shelter_info.Service_Status.Firecode_Space.Firecode_Capacity;
      current_circle_color = map_occupancy_to_color(current_shelter_occupancy,current_shelter_capacity);

      //Draw Circles
      var current_shelter_latitude = current_shelter_info.Shelter_Properties.latitude;
      var current_shelter_longitude = current_shelter_info.Shelter_Properties.longitude;
      var current_shelter_map_coordinates = [current_shelter_latitude, current_shelter_longitude];
      var current_circle_options = {
        color: current_circle_color,
        fillColor: current_circle_color,
        fillOpacity: 0.5,
        radius: 80
      };

      if (create_shelters == true)
      {
        var current_shelter_circle = L.circle(current_shelter_map_coordinates, current_circle_options).addTo(chalmers_map);
        set_circle_radius(current_shelter_circle, chalmers_map);
        //Bind That Cirlce to PopUp
        bindPopup(current_shelter_circle);
        //Add Circle to Cirlce-Tracker
        shelter_circles.push(current_shelter_circle);
      }else if (create_shelters == false) {
        current_shelter_circle = shelter_circles[i];
        set_circle_radius(current_shelter_circle, chalmers_map);
        current_shelter_circle.setCircleColor()
        //Bind That Cirlce to PopUp
        bindPopup(current_shelter_circle);
      }
    }

}
/* main script starts here */
grab_data();
render_shelters(true); //instatiate the shelters
var interval = setInterval(function(){render_shelters(false);}, 1000); //update the shelters
</script>

</html>
